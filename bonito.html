<html>
        <head>
            <script src="/socket.io/socket.io.js"></script>
            <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
            <script src="modules/mustache/mustache.min.js"></script>
            <link rel="stylesheet" href="assets/main.css"/>
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    
            <script>
                // Conecta no socket
                const socket = io('http://localhost:3000');
                var messages = [];
                var users = [];
                var messagesTemplate = '';
                var usersTemplate = '';
                var private = false;
                var private_id = null;
                var privateConversations = []; 
    
                $(document).ready(() => {
                    // Pré parseia o template de mensagens
                    messagesTemplate = $('#mensagens-tmpl').html();
                    Mustache.parse(messagesTemplate);
    
                    // Pré parseia o template de usuarios
                    usersTemplate = $('#users-tmpl').html();
                    Mustache.parse(usersTemplate);

                    // Pré parseia o template de novas mensagens privadas
                    privatesTemplate = $('#privates-tmpl').html();
                    Mustache.parse(privatesTemplate);
    
    
                    // Função criada para facilitar a renderizacao de templates
                    // do mustache.js
                    // Aceita um template, dados e uma div target para renderizar
                    let renderTemplate = function(template, data, target) {
                        let rendered = Mustache.render(template, data);
                        target.html(rendered);
                    };
    
                    // Ao conectar no socket, pedir um nome
                    socket.on('connected', (data) => {
                        let nome = prompt("Qual seu nome?", "");
                        socket.emit('connected-ack', {nome});
                        $('#nomeUsuario').html(nome);
                    });
    
                    // Ação de enviar mensagem
                    $('#enviar').click(() => {
                        let msg = $('#input-msg').val();
                        if (!private) {
                            socket.emit('new-message', {msg});
                        } else {
                            socket.emit('private-message', {to: private_id, msg: msg});
                        }
                        $('#input-msg').val('');
                    });
    
                    // Evento de receber uma nova mensagem
                    socket.on('client-new-message', (data) => {
                        renderTemplate(messagesTemplate, {messages: data.messages}, $('#mensagens-container'));
                    });
    
                    // Evento de novo usuário conectado
                    socket.on('client-new-user', (data) => {
                        renderTemplate(usersTemplate, {users: data.users}, $('#users-container'));
                    });
    
                    // Evento de novo usuário na sala
                    socket.on('client-join-room', (data) => {
                        renderTemplate(messagesTemplate, {messages: data.messages}, $('#mensagens-container'));
                        renderTemplate(usersTemplate, {users: data.users}, $('#users-container'));
                    });
    
                    // Evento de usuário desconectado
                    socket.on('client-user-disconnected', (data) => {
                        renderTemplate(usersTemplate, {users: data.users}, $('#users-container'));
                    });

                    // Evento de entrar em sala privada
                    socket.on('client-join-private-room', (data) => {
                        renderTemplate(messagesTemplate, {messages: data.messages}, $('#mensagens-container'));
                    });

                    socket.on('client-private-message', (data) => {
                        console.log('New Private Message Received!');
                        console.log(data);

                        conversation = _.find(privateConversations, (v) => {
                            return v.id == data.id
                        });

                        if (conversation === undefined) {
                            privateConversations.push(data);
                        } else {
                            conversation = data;
                            conversation.hasNewMessage = true;
                        }
                        
                        renderTemplate(privatesTemplate, {privates: privateConversations}, $('#privates-container'));
                    });
    
                    // Mudança de sala
                    $(document).on('click', '.sala', (event) => {
                        console.log(event.target);
                        socket.emit('join-room', {id: $(event.target).attr('room')});
                        private = false;
                        private_id = null;
                        $('#salaAtual').html(`Sala ${$(event.target).attr('room')}`);
                    })

                    $(document).on('click', '.user-item', (event) => {
                        console.log($(event.target).attr('socket'));
                        socket.emit('join-room', {id: $(event.target).attr('socket'), nome: $(event.target).attr('nome'), private: true});
                        private = true;
                        private_id = $(event.target).attr('socket');
                        $('#salaAtual').html(`Conversa privada com ${$(event.target).attr('nome')}`);
                    })

                    $(document).on('click', '.private-item', (event) => {

                        let private_id = $(event.target).attr('privateid');

                        conversation = _.find(privateConversations, (v) => {
                            return v.id == private_id
                        });

                        renderTemplate(messagesTemplate, {messages: conversation.messages}, $('#mensagens-container'));
                        // $('#salaAtual').html(`Conversa privada com ${$(event.target).attr('nome')}`);
                    })
                });
    
            </script>
        </head>
        <body>    
    
    <header>
        
        <nav>
        <ul class="navigation">
      <li class="navigation__brand">
          <div class="">
                  <a href="#"> OpenJobs / <span id="salaAtual">Sala Global</span></a>
          </div>
            </li>
    </ul>		
        </nav>
    </header>
    
    <div class="grid">	
        <sidebar class="col__10"> <!--sidebar-offcanvas --> 		
            
            <ul class="sidebar__menu">
                <li> <a href="#">Profile </a> </li>
                <li> <a href="#">Chat </a> </li>
                <li> <a href="#">Premium </a> </li>
                <li> <a href="#">Star </a> </li>
                <li> <a href="#">Show </a> </li>
                <li> <a href="#">Rocket </a> </li>
                <li> <a href="#">Gravity </a> </li>
            </ul>
                
        </sidebar> <!--/col10 -->
        <sidebar class="col__20 "> <!--sidebar -->
                
            <div class="box">
                
                <span class="box__contacts--menu js-offcanvas">  
                    <i class="fa fa-bars"  aria-hidden="true"></i>
                </span>

                <h4 class="box__contacts--title">Salas Abertas  
                    <i class="fa fa-comment-o" aria-hidden="true"></i>
                </h4>

                <ul class="box__contacts" id="salasGlobais">				
                    <li class="sala" room="global">
                        <a>
                            <div class="box__photo">
                                <img src="https://api.adorable.io/avatars/60/global.png" alt="" class="box__contacts--images">
                            </div>
                            <span class="box__contacts--name">Sala Global</span> <br>					
                        </a>						
                    </li>

                    <li class="sala" room="1">
                        <a>
                            <div class="box__photo">
                                <img src="https://api.adorable.io/avatars/60/sala1.png" alt="" class="box__contacts--images">
                            </div>
                            <span class="box__contacts--name">Sala 1</span> <br>					
                        </a>						
                    </li>

                    <li class="sala" room="2">
                        <a>
                            <div class="box__photo">
                                <img src="https://api.adorable.io/avatars/60/sala2.png" alt="" class="box__contacts--images">
                            </div>
                            <span class="box__contacts--name">Sala 2</span> <br>					
                        </a>						
                    </li>
                </ul>

                <hr>
                
                <h4 class="box__contacts--title">Conversas privadas 
                    <i class="fa fa-comment-o" aria-hidden="true"></i>
                    </h4>
            
                
                <ul class="box__contacts" id="privates-container">				
                    
                </ul>

                <hr>

                <h4 class="box__contacts--title">Usuários na Sala 
                    <i class="fa fa-comment-o" aria-hidden="true"></i>
                 </h4>
            
             
                <ul class="box__contacts" id="users-container">				
                    
                </ul>
                </div>
            </sidebar> <!-- col--20-->
            
        
        <div class="col__70 js_wrapper">	<!--content -->

            <div class="box__contacts--search">
                <input type="text" id="input-msg" placeholder="Digite sua mensagem..."> <button type="submit" id="enviar">Enviar</button>
            </div>
            <div id="mensagens-container">

            </div>
        </div>
        
        
    </div>

    <script id="mensagens-tmpl" type="x-tmpl-mustache">
        <ul id="mensagens">
            {{#messages}}
            <li class="mensagens-item"><b>{{from}}</b> - {{msg}}</li>
            {{/messages}}
        </ul>
    </script>

    <script id="users-tmpl" type="x-tmpl-mustache">
        {{#users}}
        <li class="user-item" socket="{{socket_id}}" nome="{{nome}}">
            <a>
                <div class="box__photo">
                    <img src="https://api.adorable.io/avatars/60/{{socket_id}}.png" alt="" class="box__contacts--images">
                </div>
                <span class="box__contacts--name">{{nome}}</span> <br>		
                <span class="box__contacts--lastMessage"> "{{socket_id}}"</span>						
            </a>						
        </li>
        {{/users}}
    </script>

    <script id="privates-tmpl" type="x-tmpl-mustache">
        {{#privates}}
        <li class="private-item" privateid="{{id}}">
            <a>
                <div class="box__photo">
                    <img src="https://api.adorable.io/avatars/60/{{id}}.png" alt="" class="box__contacts--images">
                </div>
                <span class="box__contacts--name">{{messages[0].from}}</span> <br>		
                <span class="box__contacts--lastMessage"> Nova mensagem</span>						
            </a>						
        </li>
        {{/privates}}
    </script>


    <script>
        $(document).ready(() => {
            $('.js-offcanvas').click(function() {
            $('.grid').toggleClass('js-showMenu');
                resizeWrapper();
            });

            function resizeWrapper(){
                let checkClass = document.getElementByClassName("js-showMenu");
                let wrapper = document.getElementsByClassName("js_wrapper");
                
                if(checkClass > 0) {
                    wrapper.style.width= "78%";		 
                    return true;
                }else {
                        wrapper.style.width= "67%";		 
                    return false;
                }	
            }
        });
    </script>

</body>

</html>